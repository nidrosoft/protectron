"use client";

import { useState } from "react";
import { cx } from "@/utils/cx";
import { Calendar, TickCircle, ExportSquare } from "iconsax-react";

interface CalendarIntegrationProps {
  daysUntilDeadline: number;
  companyName: string;
  hasHighRisk: boolean;
}

interface CalendarEvent {
  title: string;
  date: Date;
  description: string;
}

export function CalendarIntegration({ daysUntilDeadline, companyName, hasHighRisk }: CalendarIntegrationProps) {
  const [addedToCalendar, setAddedToCalendar] = useState(false);

  // Calculate milestone dates
  const deadline = new Date("2026-08-02");
  const today = new Date();
  
  const milestones: CalendarEvent[] = [
    {
      title: "EU AI Act: Complete Documentation",
      date: new Date("2026-03-01"),
      description: "Target date to complete all compliance documentation (50% buffer before deadline)",
    },
    {
      title: "EU AI Act: Internal Audit Complete",
      date: new Date("2026-05-01"),
      description: "Complete internal compliance audit and address any gaps (3 months buffer)",
    },
    {
      title: "EU AI Act: Final Review",
      date: new Date("2026-07-01"),
      description: "Final review and fixes before deadline (1 month buffer)",
    },
    {
      title: "EU AI Act: COMPLIANCE DEADLINE",
      date: deadline,
      description: "High-risk AI systems must be fully compliant with EU AI Act",
    },
  ];

  // Generate ICS file content
  const generateICS = (): string => {
    const formatDate = (date: Date) => {
      return date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
    };

    let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Protectron//EU AI Act Compliance//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

    milestones.forEach((event, index) => {
      const uid = `protectron-euaiact-${index}@protectron.ai`;
      icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formatDate(today)}
DTSTART;VALUE=DATE:${event.date.toISOString().split("T")[0].replace(/-/g, "")}
DTEND;VALUE=DATE:${event.date.toISOString().split("T")[0].replace(/-/g, "")}
SUMMARY:${event.title}
DESCRIPTION:${event.description} - ${companyName}
STATUS:CONFIRMED
END:VEVENT
`;
    });

    icsContent += "END:VCALENDAR";
    return icsContent;
  };

  // Generate Google Calendar URL
  const generateGoogleCalendarUrl = (event: CalendarEvent): string => {
    const startDate = event.date.toISOString().split("T")[0].replace(/-/g, "");
    const endDate = startDate; // All-day event
    const title = encodeURIComponent(event.title);
    const description = encodeURIComponent(`${event.description}\n\nGenerated by Protectron - EU AI Act Compliance Platform`);
    
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${description}`;
  };

  // Generate Outlook URL
  const generateOutlookUrl = (event: CalendarEvent): string => {
    const startDate = event.date.toISOString();
    const title = encodeURIComponent(event.title);
    const description = encodeURIComponent(event.description);
    
    return `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&startdt=${startDate}&body=${description}&allday=true`;
  };

  // Download ICS file
  const downloadICS = () => {
    const icsContent = generateICS();
    const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `EU-AI-Act-Compliance-Milestones-${companyName.replace(/[^a-zA-Z0-9]/g, "_")}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    setAddedToCalendar(true);
  };

  // Open Google Calendar for main deadline
  const addToGoogleCalendar = () => {
    const mainDeadline = milestones[milestones.length - 1];
    window.open(generateGoogleCalendarUrl(mainDeadline), "_blank");
    setAddedToCalendar(true);
  };

  // Open Outlook for main deadline
  const addToOutlook = () => {
    const mainDeadline = milestones[milestones.length - 1];
    window.open(generateOutlookUrl(mainDeadline), "_blank");
    setAddedToCalendar(true);
  };

  return (
    <section className="mb-8 sm:mb-12">
      {/* Section Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-100 dark:bg-brand-900/30 text-brand-600">
          <Calendar size={20} color="currentColor" variant="Bold" />
        </div>
        <div>
          <h2 className="text-lg font-semibold text-primary dark:text-white sm:text-xl">
            Add to Your Calendar
          </h2>
          <p className="text-sm text-tertiary dark:text-gray-400">
            Never miss a compliance milestone
          </p>
        </div>
      </div>

      {/* Calendar Card */}
      <div className="rounded-xl border border-secondary dark:border-gray-700 bg-white dark:bg-gray-800 p-4 sm:p-6">
        {/* Milestones Preview */}
        <div className="mb-6">
          <h3 className="text-sm font-semibold text-primary dark:text-white mb-3">
            Milestones we'll add to your calendar:
          </h3>
          <div className="space-y-2">
            {milestones.map((milestone, index) => {
              const isDeadline = index === milestones.length - 1;
              return (
                <div
                  key={index}
                  className={cx(
                    "flex items-center gap-3 p-2 rounded-lg",
                    isDeadline 
                      ? "bg-warning-50 dark:bg-warning-900/20 border border-warning-200 dark:border-warning-800" 
                      : "bg-gray-50 dark:bg-gray-700/50"
                  )}
                >
                  <div className={cx(
                    "flex h-8 w-8 shrink-0 items-center justify-center rounded-lg text-xs font-bold",
                    isDeadline 
                      ? "bg-warning-200 dark:bg-warning-800 text-warning-700 dark:text-warning-300" 
                      : "bg-brand-100 dark:bg-brand-900/30 text-brand-600"
                  )}>
                    {milestone.date.toLocaleDateString("en-US", { month: "short" }).toUpperCase()}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className={cx(
                      "text-sm font-medium truncate",
                      isDeadline 
                        ? "text-warning-800 dark:text-warning-200" 
                        : "text-primary dark:text-white"
                    )}>
                      {milestone.title}
                    </p>
                    <p className="text-xs text-tertiary dark:text-gray-400">
                      {milestone.date.toLocaleDateString("en-US", { 
                        month: "long", 
                        day: "numeric", 
                        year: "numeric" 
                      })}
                    </p>
                  </div>
                  {isDeadline && (
                    <span className="shrink-0 px-2 py-0.5 rounded text-xs font-semibold bg-warning-200 dark:bg-warning-800 text-warning-700 dark:text-warning-300">
                      DEADLINE
                    </span>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Calendar Buttons */}
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <button
            onClick={addToGoogleCalendar}
            className="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            <svg className="h-5 w-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span className="text-sm font-medium text-primary dark:text-white">Google Calendar</span>
          </button>

          <button
            onClick={addToOutlook}
            className="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            <svg className="h-5 w-5" viewBox="0 0 24 24">
              <path fill="#0078D4" d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.152-.354.228-.588.228h-8.174v-6.182l1.602 1.176c.086.063.184.095.293.095.11 0 .207-.032.293-.095l6.574-4.825c.086-.063.152-.14.199-.232.047-.091.039-.165-.024-.22-.063-.055-.152-.082-.267-.082H15v-1.93h8.174c.234 0 .43.076.588.228.158.152.238.346.238.576v.209zM14 18.669V5.331c0-.23-.08-.424-.238-.576-.158-.152-.354-.228-.588-.228H1.826c-.234 0-.43.076-.588.228C1.08 4.907 1 5.101 1 5.331v13.338c0 .23.08.424.238.576.158.152.354.228.588.228h11.348c.234 0 .43-.076.588-.228.158-.152.238-.346.238-.576zm-6.5-9.669c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3z"/>
            </svg>
            <span className="text-sm font-medium text-primary dark:text-white">Outlook</span>
          </button>

          <button
            onClick={downloadICS}
            className="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            <span className="text-gray-600 dark:text-gray-400"><ExportSquare size={20} color="currentColor" variant="Bold" /></span>
            <span className="text-sm font-medium text-primary dark:text-white">Download .ics</span>
          </button>
        </div>

        {/* Success Message */}
        {addedToCalendar && (
          <div className="mt-4 flex items-center gap-2 p-3 rounded-lg bg-success-50 dark:bg-success-900/20 border border-success-200 dark:border-success-800">
            <span className="text-success-600"><TickCircle size={16} color="currentColor" variant="Bold" /></span>
            <span className="text-sm text-success-700 dark:text-success-300">
              Calendar events ready! Check your calendar app.
            </span>
          </div>
        )}
      </div>
    </section>
  );
}
