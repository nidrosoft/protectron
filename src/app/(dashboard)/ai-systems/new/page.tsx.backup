"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import {
  ArrowLeft,
  ArrowRight,
  Cpu,
  Warning2,
  InfoCircle,
  TickCircle,
  Danger,
  ShieldTick,
  Global,
  People,
  DocumentText,
  Chart,
} from "iconsax-react";
import { ArrowLeft as ArrowLeftIcon, Check, Building07, Target04, Database02, Globe04, CheckCircle } from "@untitledui/icons";
import { Progress } from "@/components/application/progress-steps/progress-steps";
import type { ProgressFeaturedIconType } from "@/components/application/progress-steps/progress-types";
import { Button } from "@/components/base/buttons/button";
import { Input, TextField } from "@/components/base/input/input";
import { TextArea } from "@/components/base/textarea/textarea";
import { Select, type SelectItemType } from "@/components/base/select/select";
import { SelectItem } from "@/components/base/select/select-item";
import { Checkbox } from "@/components/base/checkbox/checkbox";
import { Badge } from "@/components/base/badges/badges";
import { ProgressBarBase } from "@/components/base/progress-indicators/progress-indicators";
import { FeaturedIcon } from "@/components/foundations/featured-icon/featured-icon";
import { cx } from "@/utils/cx";

// Step definitions for display
const stepNames = [
  { id: 1, name: "Basic Information", description: "System name and provider" },
  { id: 2, name: "Use Case", description: "How the AI is used" },
  { id: 3, name: "Data & Privacy", description: "Data types processed" },
  { id: 4, name: "EU Exposure", description: "EU market presence" },
  { id: 5, name: "Risk Classification", description: "Review and confirm" },
];

// Function to generate progress steps based on current step
const getProgressSteps = (currentStep: number): ProgressFeaturedIconType[] => [
  { 
    title: "Basic Information", 
    description: "System name and provider", 
    status: currentStep > 1 ? "complete" : currentStep === 1 ? "current" : "incomplete",
    icon: Building07 
  },
  { 
    title: "Use Case", 
    description: "How the AI is used", 
    status: currentStep > 2 ? "complete" : currentStep === 2 ? "current" : "incomplete",
    icon: Target04 
  },
  { 
    title: "Data & Privacy", 
    description: "Data types processed", 
    status: currentStep > 3 ? "complete" : currentStep === 3 ? "current" : "incomplete",
    icon: Database02 
  },
  { 
    title: "EU Exposure", 
    description: "EU market presence", 
    status: currentStep > 4 ? "complete" : currentStep === 4 ? "current" : "incomplete",
    icon: Globe04 
  },
  { 
    title: "Risk Classification", 
    description: "Review and confirm", 
    status: currentStep === 5 ? "current" : "incomplete",
    icon: CheckCircle 
  },
];

// Provider options
const providers: SelectItemType[] = [
  { id: "openai", label: "OpenAI" },
  { id: "anthropic", label: "Anthropic" },
  { id: "google", label: "Google" },
  { id: "microsoft", label: "Microsoft" },
  { id: "meta", label: "Meta" },
  { id: "custom", label: "Custom / In-house" },
  { id: "other", label: "Other" },
];

// Deployment status options
const deploymentStatuses: SelectItemType[] = [
  { id: "development", label: "In Development" },
  { id: "testing", label: "Testing" },
  { id: "production", label: "Production" },
];

// Use case categories
const useCaseCategories: SelectItemType[] = [
  { id: "customer-service", label: "Customer Service / Chatbots" },
  { id: "content-generation", label: "Content Generation" },
  { id: "data-analysis", label: "Data Analysis / BI" },
  { id: "hiring", label: "Hiring / Recruitment ⚠️" },
  { id: "healthcare", label: "Healthcare / Medical ⚠️" },
  { id: "finance", label: "Finance / Credit ⚠️" },
  { id: "education", label: "Education / Training" },
  { id: "security", label: "Security / Fraud Detection" },
  { id: "marketing", label: "Marketing / Personalization" },
  { id: "legal", label: "Legal / Compliance" },
  { id: "other", label: "Other" },
];

// Decision automation options
const decisionTypes: SelectItemType[] = [
  { id: "automated", label: "Fully Automated" },
  { id: "human-in-loop", label: "Human-in-the-Loop" },
  { id: "advisory", label: "Advisory Only (Human Decides)" },
];

// Impact levels
const impactLevels: SelectItemType[] = [
  { id: "low", label: "Low - Minor convenience impact" },
  { id: "medium", label: "Medium - Affects access to services" },
  { id: "high", label: "High - Significant life impact ⚠️" },
];

// Data types
const dataTypes = [
  { id: "pii", label: "Personal Identifiable Info (PII)", warning: false },
  { id: "biometric", label: "Biometric Data", warning: true },
  { id: "health", label: "Health Data", warning: true },
  { id: "financial", label: "Financial Data", warning: false },
  { id: "location", label: "Location Data", warning: false },
  { id: "public", label: "Public Data Only", warning: false },
  { id: "synthetic", label: "Synthetic / Anonymized Data", warning: false },
];

// Data subjects
const dataSubjects = [
  { id: "employees", label: "Employees" },
  { id: "customers", label: "Customers" },
  { id: "eu-residents", label: "EU Residents", warning: true },
  { id: "general-public", label: "General Public" },
];

// Form state type
interface FormData {
  // Step 1
  name: string;
  description: string;
  provider: string;
  modelName: string;
  deploymentStatus: string;
  // Step 2
  useCase: string;
  makesDecisions: boolean;
  decisionType: string;
  impactLevel: string;
  // Step 3
  dataTypes: string[];
  dataSubjects: string[];
  // Step 4
  servesEU: boolean;
  processesInEU: boolean;
  establishedInEU: boolean;
}

// Risk calculation function
function calculateRiskLevel(data: FormData): {
  level: "prohibited" | "high" | "limited" | "minimal";
  reasons: string[];
  requirements: number;
} {
  const reasons: string[] = [];
  
  // Check for prohibited practices (simplified)
  // In reality, this would be more complex
  
  // Check for high-risk indicators
  const highRiskUseCases = ["hiring", "healthcare", "finance"];
  const highRiskDataTypes = ["biometric", "health"];
  
  const isHighRiskUseCase = highRiskUseCases.includes(data.useCase);
  const hasHighRiskData = data.dataTypes.some(dt => highRiskDataTypes.includes(dt));
  const hasHighImpact = data.impactLevel === "high";
  const isAutomated = data.decisionType === "automated";
  const affectsEU = data.servesEU || data.processesInEU || data.establishedInEU;
  const affectsEUResidents = data.dataSubjects.includes("eu-residents");
  
  if (isHighRiskUseCase) reasons.push(`High-risk use case: ${data.useCase}`);
  if (hasHighRiskData) reasons.push("Processes sensitive data types");
  if (hasHighImpact) reasons.push("High impact on individuals");
  if (isAutomated && data.makesDecisions) reasons.push("Automated decision-making");
  
  // Determine risk level
  if ((isHighRiskUseCase || hasHighRiskData) && affectsEU) {
    return { level: "high", reasons, requirements: 24 };
  }
  
  if (data.makesDecisions && affectsEU) {
    return { level: "limited", reasons: ["Makes decisions affecting people", "EU exposure"], requirements: 8 };
  }
  
  if (affectsEU || affectsEUResidents) {
    return { level: "limited", reasons: ["EU market exposure"], requirements: 8 };
  }
  
  return { level: "minimal", reasons: ["No high-risk indicators"], requirements: 2 };
}

export default function NewAISystemPage() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [formData, setFormData] = useState<FormData>({
    name: "",
    description: "",
    provider: "",
    modelName: "",
    deploymentStatus: "",
    useCase: "",
    makesDecisions: false,
    decisionType: "",
    impactLevel: "",
    dataTypes: [],
    dataSubjects: [],
    servesEU: false,
    processesInEU: false,
    establishedInEU: false,
  });

  const updateFormData = (updates: Partial<FormData>) => {
    setFormData(prev => ({ ...prev, ...updates }));
  };

  const toggleArrayItem = (field: "dataTypes" | "dataSubjects", item: string) => {
    setFormData(prev => ({
      ...prev,
      [field]: prev[field].includes(item)
        ? prev[field].filter(i => i !== item)
        : [...prev[field], item],
    }));
  };

  const canProceed = () => {
    switch (currentStep) {
      case 1:
        return formData.name.trim() !== "" && formData.provider !== "";
      case 2:
        return formData.useCase !== "";
      case 3:
        return formData.dataTypes.length > 0;
      case 4:
        return true; // All boolean, always valid
      case 5:
        return true;
      default:
        return false;
    }
  };

  const handleNext = () => {
    if (currentStep < 5) {
      setCurrentStep(currentStep + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleSubmit = async () => {
    setIsSubmitting(true);
    // In a real app, this would save to the database
    console.log("Submitting AI System:", formData);
    
    // Simulate API call with loading state
    await new Promise(resolve => setTimeout(resolve, 2500));
    
    router.push("/ai-systems");
  };

  const riskResult = calculateRiskLevel(formData);

  const riskConfig = {
    prohibited: { color: "error" as const, icon: Danger, label: "Prohibited", bgColor: "bg-error-50", textColor: "text-error-700" },
    high: { color: "warning" as const, icon: Warning2, label: "High Risk", bgColor: "bg-warning-50", textColor: "text-warning-700" },
    limited: { color: "brand" as const, icon: InfoCircle, label: "Limited Risk", bgColor: "bg-brand-50", textColor: "text-brand-700" },
    minimal: { color: "success" as const, icon: TickCircle, label: "Minimal Risk", bgColor: "bg-success-50", textColor: "text-success-700" },
  };

  // Show loading overlay when submitting
  if (isSubmitting) {
    return (
      <div className="flex h-full flex-col items-center justify-center gap-6 p-8">
        <div className="flex h-16 w-16 items-center justify-center rounded-full bg-brand-100">
          <Cpu size={32} className="animate-pulse text-brand-600" color="currentColor" variant="Bold" />
        </div>
        <div className="flex flex-col items-center gap-2 text-center">
          <h2 className="text-xl font-semibold text-primary">Adding Your AI System</h2>
          <p className="text-sm text-tertiary">
            Setting up {formData.name} and configuring compliance requirements...
          </p>
        </div>
        <div className="flex items-center gap-2">
          <div className="h-2 w-2 animate-bounce rounded-full bg-brand-600" style={{ animationDelay: "0ms" }} />
          <div className="h-2 w-2 animate-bounce rounded-full bg-brand-600" style={{ animationDelay: "150ms" }} />
          <div className="h-2 w-2 animate-bounce rounded-full bg-brand-600" style={{ animationDelay: "300ms" }} />
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-full flex-col overflow-hidden">
      {/* Fixed Header */}
      <div className="shrink-0 border-b border-secondary bg-primary px-6 py-4 lg:px-8">
        <div className="flex items-center gap-4">
          <Link
            href="/ai-systems"
            className="flex h-9 w-9 items-center justify-center rounded-lg border border-secondary hover:bg-secondary"
          >
            <ArrowLeftIcon className="h-5 w-5 text-quaternary" />
          </Link>
          <div>
            <h1 className="text-lg font-semibold text-primary">Add AI System</h1>
            <p className="text-sm text-tertiary">Step {currentStep} of 5: {stepNames[currentStep - 1].name}</p>
          </div>
        </div>
      </div>

      {/* Fixed Progress Bar */}
      <div className="shrink-0 border-b border-secondary bg-primary px-6 py-4 lg:px-8">
        <Progress.IconsWithText 
          type="number" 
          items={getProgressSteps(currentStep)} 
          size="sm" 
          orientation="horizontal" 
          className="max-md:hidden" 
        />
        <Progress.IconsWithText 
          type="number" 
          items={getProgressSteps(currentStep)} 
          size="sm" 
          orientation="vertical" 
          className="md:hidden" 
        />
      </div>

      {/* Scrollable Form Content */}
      <div className="flex-1 overflow-y-auto px-6 py-8 lg:px-8">
        <div className="mx-auto max-w-2xl">
          {/* Step 1: Basic Information */}
          {currentStep === 1 && (
            <div className="flex flex-col gap-6">
              <div>
                <h2 className="text-xl font-semibold text-primary">Basic Information</h2>
                <p className="mt-1 text-sm text-tertiary">
                  Tell us about your AI system and its provider.
                </p>
              </div>

              <TextField label="System Name" isRequired>
                <Input
                  placeholder="e.g., Customer Support Chatbot"
                  value={formData.name}
                  onChange={(value: string) => updateFormData({ name: value })}
                />
              </TextField>

              <TextArea
                label="Description"
                placeholder="Briefly describe what this AI system does..."
                value={formData.description}
                onChange={(value: string) => updateFormData({ description: value })}
              />

              <Select
                label="Provider"
                placeholder="Select provider"
                selectedKey={formData.provider}
                onSelectionChange={(key: React.Key) => updateFormData({ provider: key as string })}
                items={providers}
              >
                {(item) => <SelectItem id={item.id}>{item.label}</SelectItem>}
              </Select>

              <TextField label="Model Name">
                <Input
                  placeholder="e.g., GPT-4, Claude 3, Custom ML"
                  value={formData.modelName}
                  onChange={(value: string) => updateFormData({ modelName: value })}
                />
              </TextField>

              <Select
                label="Deployment Status"
                placeholder="Select status"
                selectedKey={formData.deploymentStatus}
                onSelectionChange={(key: React.Key) => updateFormData({ deploymentStatus: key as string })}
                items={deploymentStatuses}
              >
                {(item) => <SelectItem id={item.id}>{item.label}</SelectItem>}
              </Select>
            </div>
          )}

          {/* Step 2: Use Case Classification */}
          {currentStep === 2 && (
            <div className="flex flex-col gap-6">
              <div>
                <h2 className="text-xl font-semibold text-primary">Use Case Classification</h2>
                <p className="mt-1 text-sm text-tertiary">
                  Help us understand how this AI system is used.
                </p>
              </div>

              <Select
                label="Primary Use Case"
                placeholder="Select use case category"
                selectedKey={formData.useCase}
                onSelectionChange={(key: React.Key) => updateFormData({ useCase: key as string })}
                items={useCaseCategories}
              >
                {(item) => <SelectItem id={item.id}>{item.label}</SelectItem>}
              </Select>

              {["hiring", "healthcare", "finance"].includes(formData.useCase) && (
                <div className="rounded-lg border border-warning-200 bg-warning-50 p-4">
                  <div className="flex gap-3">
                    <Warning2 size={20} className="shrink-0 text-warning-600" color="currentColor" />
                    <div>
                      <p className="text-sm font-medium text-warning-800">High-Risk Category</p>
                      <p className="mt-1 text-sm text-warning-700">
                        This use case is classified as high-risk under the EU AI Act and requires full compliance.
                      </p>
                    </div>
                  </div>
                </div>
              )}

              <div className="flex flex-col gap-3">
                <label className="text-sm font-medium text-primary">
                  Does this AI make or assist decisions about people?
                </label>
                <div className="flex gap-4">
                  <button
                    type="button"
                    onClick={() => updateFormData({ makesDecisions: true })}
                    className={cx(
                      "flex-1 rounded-lg border p-4 text-left transition",
                      formData.makesDecisions
                        ? "border-brand-600 bg-brand-50 ring-2 ring-brand-600"
                        : "border-secondary hover:border-brand-300"
                    )}
                  >
                    <span className="text-sm font-medium text-primary">Yes</span>
                  </button>
                  <button
                    type="button"
                    onClick={() => updateFormData({ makesDecisions: false })}
                    className={cx(
                      "flex-1 rounded-lg border p-4 text-left transition",
                      !formData.makesDecisions
                        ? "border-brand-600 bg-brand-50 ring-2 ring-brand-600"
                        : "border-secondary hover:border-brand-300"
                    )}
                  >
                    <span className="text-sm font-medium text-primary">No</span>
                  </button>
                </div>
              </div>

              {formData.makesDecisions && (
                <>
                  <Select
                    label="Decision Automation Level"
                    placeholder="Select automation level"
                    selectedKey={formData.decisionType}
                    onSelectionChange={(key: React.Key) => updateFormData({ decisionType: key as string })}
                    items={decisionTypes}
                  >
                    {(item) => <SelectItem id={item.id}>{item.label}</SelectItem>}
                  </Select>

                  <Select
                    label="Impact Level of Decisions"
                    placeholder="Select impact level"
                    selectedKey={formData.impactLevel}
                    onSelectionChange={(key: React.Key) => updateFormData({ impactLevel: key as string })}
                    items={impactLevels}
                  >
                    {(item) => <SelectItem id={item.id}>{item.label}</SelectItem>}
                  </Select>
                </>
              )}
            </div>
          )}

          {/* Step 3: Data & Privacy */}
          {currentStep === 3 && (
            <div className="flex flex-col gap-6">
              <div>
                <h2 className="text-xl font-semibold text-primary">Data & Privacy</h2>
                <p className="mt-1 text-sm text-tertiary">
                  What types of data does this AI system process?
                </p>
              </div>

              <div className="flex flex-col gap-3">
                <label className="text-sm font-medium text-primary">
                  Data Types Processed <span className="text-error-500">*</span>
                </label>
                <div className="flex flex-col gap-2">
                  {dataTypes.map((dt) => (
                    <label
                      key={dt.id}
                      className={cx(
                        "flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition",
                        formData.dataTypes.includes(dt.id)
                          ? "border-brand-600 bg-brand-50"
                          : "border-secondary hover:border-brand-300"
                      )}
                    >
                      <Checkbox
                        isSelected={formData.dataTypes.includes(dt.id)}
                        onChange={() => toggleArrayItem("dataTypes", dt.id)}
                      />
                      <span className="text-sm text-primary">{dt.label}</span>
                      {dt.warning && (
                        <Badge color="warning" size="sm">High Risk</Badge>
                      )}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex flex-col gap-3">
                <label className="text-sm font-medium text-primary">
                  Who is affected by this AI system?
                </label>
                <div className="flex flex-col gap-2">
                  {dataSubjects.map((ds) => (
                    <label
                      key={ds.id}
                      className={cx(
                        "flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition",
                        formData.dataSubjects.includes(ds.id)
                          ? "border-brand-600 bg-brand-50"
                          : "border-secondary hover:border-brand-300"
                      )}
                    >
                      <Checkbox
                        isSelected={formData.dataSubjects.includes(ds.id)}
                        onChange={() => toggleArrayItem("dataSubjects", ds.id)}
                      />
                      <span className="text-sm text-primary">{ds.label}</span>
                      {ds.warning && (
                        <Badge color="warning" size="sm">EU Exposure</Badge>
                      )}
                    </label>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Step 4: EU Exposure */}
          {currentStep === 4 && (
            <div className="flex flex-col gap-6">
              <div>
                <h2 className="text-xl font-semibold text-primary">EU Exposure</h2>
                <p className="mt-1 text-sm text-tertiary">
                  The EU AI Act applies if you have any connection to the EU market.
                </p>
              </div>

              <div className="flex flex-col gap-4">
                <label
                  className={cx(
                    "flex cursor-pointer items-start gap-4 rounded-xl border p-4 transition",
                    formData.servesEU
                      ? "border-brand-600 bg-brand-50 ring-2 ring-brand-600"
                      : "border-secondary hover:border-brand-300"
                  )}
                  onClick={() => updateFormData({ servesEU: !formData.servesEU })}
                >
                  <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-brand-100">
                    <People size={20} className="text-brand-600" color="currentColor" />
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-primary">Serves EU Users/Customers</p>
                    <p className="mt-1 text-sm text-tertiary">
                      This AI system is used by or affects people in the European Union.
                    </p>
                  </div>
                  <Checkbox isSelected={formData.servesEU} onChange={() => {}} />
                </label>

                <label
                  className={cx(
                    "flex cursor-pointer items-start gap-4 rounded-xl border p-4 transition",
                    formData.processesInEU
                      ? "border-brand-600 bg-brand-50 ring-2 ring-brand-600"
                      : "border-secondary hover:border-brand-300"
                  )}
                  onClick={() => updateFormData({ processesInEU: !formData.processesInEU })}
                >
                  <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-purple-100">
                    <Global size={20} className="text-purple-600" color="currentColor" />
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-primary">Data Processed in EU</p>
                    <p className="mt-1 text-sm text-tertiary">
                      Data is stored or processed on servers located in the European Union.
                    </p>
                  </div>
                  <Checkbox isSelected={formData.processesInEU} onChange={() => {}} />
                </label>

                <label
                  className={cx(
                    "flex cursor-pointer items-start gap-4 rounded-xl border p-4 transition",
                    formData.establishedInEU
                      ? "border-brand-600 bg-brand-50 ring-2 ring-brand-600"
                      : "border-secondary hover:border-brand-300"
                  )}
                  onClick={() => updateFormData({ establishedInEU: !formData.establishedInEU })}
                >
                  <div className="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-success-100">
                    <ShieldTick size={20} className="text-success-600" color="currentColor" />
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-primary">Company Established in EU</p>
                    <p className="mt-1 text-sm text-tertiary">
                      Your organization has a legal entity or office in the European Union.
                    </p>
                  </div>
                  <Checkbox isSelected={formData.establishedInEU} onChange={() => {}} />
                </label>
              </div>

              {!formData.servesEU && !formData.processesInEU && !formData.establishedInEU && (
                <div className="rounded-lg border border-secondary bg-secondary_subtle p-4">
                  <p className="text-sm text-tertiary">
                    If you have no EU exposure, the EU AI Act may not apply to this system. However, we recommend tracking it for best practices.
                  </p>
                </div>
              )}
            </div>
          )}

          {/* Step 5: Risk Classification */}
          {currentStep === 5 && (
            <div className="flex flex-col gap-6">
              <div>
                <h2 className="text-xl font-semibold text-primary">Risk Classification</h2>
                <p className="mt-1 text-sm text-tertiary">
                  Based on your answers, we've determined the risk level for this AI system.
                </p>
              </div>

              {/* Risk Level Card */}
              <div className={cx("rounded-xl border-2 p-6", riskConfig[riskResult.level].bgColor, `border-${riskConfig[riskResult.level].color}-200`)}>
                <div className="flex items-start gap-4">
                  <FeaturedIcon
                    size="lg"
                    icon={({ className }) => {
                      const Icon = riskConfig[riskResult.level].icon;
                      return <Icon size={24} className={className} color="currentColor" />;
                    }}
                    color={riskConfig[riskResult.level].color}
                    theme="light"
                  />
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h3 className={cx("text-xl font-semibold", riskConfig[riskResult.level].textColor)}>
                        {riskConfig[riskResult.level].label}
                      </h3>
                      <Badge color={riskConfig[riskResult.level].color} size="md">
                        {riskResult.requirements} Requirements
                      </Badge>
                    </div>
                    <p className={cx("mt-2 text-sm", riskConfig[riskResult.level].textColor)}>
                      {riskResult.level === "high" && "Full compliance required by August 2, 2026. This system requires comprehensive documentation and oversight."}
                      {riskResult.level === "limited" && "Transparency requirements apply. Users must be informed when interacting with AI."}
                      {riskResult.level === "minimal" && "No specific obligations under the EU AI Act. We recommend following best practices."}
                      {riskResult.level === "prohibited" && "This AI practice is prohibited under the EU AI Act. You must discontinue use."}
                    </p>
                  </div>
                </div>
              </div>

              {/* Reasons */}
              {riskResult.reasons.length > 0 && (
                <div className="rounded-lg border border-secondary p-4">
                  <h4 className="text-sm font-medium text-primary">Classification Factors</h4>
                  <ul className="mt-2 flex flex-col gap-1">
                    {riskResult.reasons.map((reason, index) => (
                      <li key={index} className="flex items-center gap-2 text-sm text-tertiary">
                        <span className="h-1.5 w-1.5 rounded-full bg-tertiary" />
                        {reason}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {/* Summary */}
              <div className="rounded-lg border border-secondary p-4">
                <h4 className="text-sm font-medium text-primary">System Summary</h4>
                <div className="mt-3 grid gap-3 sm:grid-cols-2">
                  <div>
                    <p className="text-xs text-tertiary">Name</p>
                    <p className="text-sm font-medium text-primary">{formData.name || "—"}</p>
                  </div>
                  <div>
                    <p className="text-xs text-tertiary">Provider</p>
                    <p className="text-sm font-medium text-primary">
                      {providers.find(p => p.id === formData.provider)?.label || "—"}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-tertiary">Use Case</p>
                    <p className="text-sm font-medium text-primary">
                      {useCaseCategories.find(c => c.id === formData.useCase)?.label || "—"}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-tertiary">EU Exposure</p>
                    <p className="text-sm font-medium text-primary">
                      {formData.servesEU || formData.processesInEU || formData.establishedInEU ? "Yes" : "No"}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Fixed Footer Navigation */}
      <div className="shrink-0 border-t border-secondary bg-primary px-6 py-4 lg:px-8">
        <div className="mx-auto flex max-w-2xl items-center justify-between">
          <Button
            size="md"
            color="secondary"
            onClick={handleBack}
            disabled={currentStep === 1}
          >
            Back
          </Button>
          
          <div className="flex gap-3">
            <Button size="md" color="secondary" onClick={() => router.push("/ai-systems")}>
              Cancel
            </Button>
            {currentStep < 5 ? (
              <Button size="md" onClick={handleNext} disabled={!canProceed()}>
                Continue
              </Button>
            ) : (
              <Button size="md" onClick={handleSubmit}>
                Add AI System
              </Button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
